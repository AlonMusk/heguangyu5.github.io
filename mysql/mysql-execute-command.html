<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../bootstrap-3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" href="../prism.css">
</head>
<body>
<div class="container">

<h1 class="page-header">mysql_execute_command(THD *thd)</h1>

<pre><code class="language-c">LEX *lex = thd->lex;
switch (lex->sql_command) {
    case SQLCOM_CREATE_DB:      mysql_create_db();
    case SQLCOM_CREATE_TABLE:   mysql_create_table();
    case SQLCOM_DROP_DB:        mysql_rm_db();
}
</code></pre>

<h3>mysql_create_db(THD *thd, char *dbname, create_info, silent)</h3>
<pre><code class="language-c">lock_schema_name(thd, dbname);
path = build_table_filename(path, path_length, dbname, tablename="", table_extension="", flags = 0);
// mysql_data_dir/db/
my_mkdir(path, 0777, ...);
// mysql_data_dir/db/db.opt
write_db_opt(thd, path, create_info);
    mysql_file_create(path);
    mysql_file_write("default-character-set=xxx\ndefault-collation=xxx\n");
if (!silent) {
    my_ok();
}
</code></pre>

<h3>mysql_create_table(THD *thd, TABLE_LIST *create_table, create_info, alter_info)</h3>
<pre><code class="language-c">/* 搞不清楚.frm文件的格式,编译一个debug版本的mysql nemiver一下.

mkdir -p mysql-debug/data

cd mysql-5.5.53
mkdir bld
cd bld
cmake ..
cmake-gui
修改install path, data path, with_debug, generate
make
make install

cd mysql-debug
./scripts/mysql_install_db --defaults-file=debug.cnf

cat debug.cnf
[client]
port = 3307
socket = /tmp/mysqld-debug.sock

[mysqld_safe]
socket = /tmp/mysqld-debug.sock

[mysqld]
user = heguangyu5
pid-file = /tmp/mysqld-debug.pid
socket = /tmp/mysqld-debug.sock
port = 3307
basedir = /home/heguangyu5/tmp/mysql-debug
datadir = /home/heguangyu5/tmp/mysql-debug/data

./bin/mysqld_safe --defaults-file=debug.cnf
./bin/mysqladmin --defaults-file=debug.cnf -uroot password '123456'
mysql -h127.0.0.1 -uroot -p123456 -P 3307
./bin/mysqladmin -h127.0.0.1 -uroot -p123456 -P 3307 shutdown

nemiver ./bin/mysqld \
    --defaults-file=debug.cnf \
    --plugin-dir=/home/heguangyu5/tmp/mysql-debug/lib/plugin \
    --log-error=/home/heguangyu5/tmp/mysql-debug/data/localhost.err

File -> Open Source File -> sql/sql_table.cc
*/

open_and_lock_tables(); // 在lxr里找不到open_and_lock_tables(..., prelocking_strategy)
                        // 这个函数定义在sql/sql_base.cc#5562
                        // open_tables(..., prelocking_strategy)定义在sql/sql_base.cc#4837
                        // 这个地方没有点其它的背景说明是搞不明白了.

mysql_create_table_no_lock(thd, create_table->db, create_table->table_name, ...);
    check_engine(); // 检查下对应的engine是否启用,以及创建表的名称和数据库的名称是否已占用.
                    // 比如mysql.user表就不能创建
    set_table_default_charset();

    // 调用engine的create()方法,create()方法返回一个handler,调用handler->init()方法
    handler *file = get_new_handler(handlerton* create_info->db_type);

    mysql_prepare_create_table();

    ha_table_exists_in_engine(thd, db, table_name);

    rea_create_table(); // create frm file
        mysql_create_frm();
        /*
            .frm文件开头的64字节是fileinfo
            在fileinfo[6]处记录着IO_SIZE=0x1000
            fileinfo[47]处记录着key_buff_length
            fileinfo[28]处记录着key_info_length, 两者的主要区别是:buff_length是计算出来的值,info_length是实际长度
            在.frm的IO_SIZE处,写入keybuff
            在.frm的IO_SIZE + key_buff_length处,make_empty_rec()
            再后边紧跟着connect_string,db_type,6个0,format_section_buff
            在.frm的0x2000处记录着forminfo, screen_buff,pack_fields
        */
</code></pre>

</div>
<script src="../prism.js"></script>
</body>
</html>
